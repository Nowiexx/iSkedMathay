<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Class View | iSkedMathay</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <script src="theme.js" defer></script>

  <style>
    :root {
      --main-bg: #f7f3ef;
      --sidebar-bg: #f2e9df;
      --text-color: #000;
      --accent1: #ff5f6d;
      --accent2: #d82cff;
      --card-bg: #fff;
      --input-border: #ddd;
    }

    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: var(--main-bg);
      color: var(--text-color);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 100px;
      background: var(--sidebar-bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      z-index: 2;
    }
    .sidebar img {
      width: 65px;
      height: 65px;
      border-radius: 50%;
      background: #fff;
      padding: 5px;
      margin-bottom: 25px;
    }
    .sidebar a {
      color: var(--accent2);
      text-decoration: none;
      font-weight: 600;
      margin: 18px 0;
      text-align: center;
    }
    .sidebar a:hover {
      transform: scale(1.1);
      text-shadow: 0 0 8px var(--accent1), 0 0 15px var(--accent2);
    }

    /* ===== Dropdown/menu button (professional) ===== */
    .menu-wrap { position: relative; display:inline-block; }
    .menuBtn {
      background: linear-gradient(to right, var(--accent1), var(--accent1));
      border: none;
      border-radius: 12px;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: 0.3s;
        }
    .menuBtn:hover { transform: scale(1.1);
  box-shadow: 0 0 10px var(--accent2);}
    .menuBtn .dot { width:6px;height:6px;background:var(--accent2);border-radius:50%;display:block;box-shadow:0 0 0 2px rgba(216,44,255,0.08); }
    .menuBtn .dot + .dot { margin-left:6px; }
    .menuBtn .dots { display:flex; gap:6px; align-items:center; }
    .menu-btn span {
      width: 6px;
      height: 6px;
      background: #fff;
      border-radius: 50%;
      display: block;
    }
    #dropdownMenu {
      display: none;
      position: absolute;
      top: 50px;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 22px rgba(0,0,0,0.15);
      padding: 6px 0;
      z-index: 60;
      min-width: 180px;
      transform-origin: top right;
    }
    #dropdownMenu.show { display:block; animation: popIn .14s ease; }
    #dropdownMenu a {
      display:block;
      padding:12px 16px;
      color:#222;
      text-decoration:none;
      font-weight:600;
      transition: background .12s;
      border-radius:8px;
    }
    #dropdownMenu a:hover { background: rgba(0,0,0,0.04); }

    /* ===== LEAVE / DELETE MODALS with blur ===== */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn .18s ease;
    }
    .overlay.show { display:flex; }

    .modal {
      background: var(--card-bg);
      padding: 26px;
      border-radius: 14px;
      max-width: 420px;
      width: 92%;
      box-shadow: 0 12px 40px rgba(0,0,0,0.18);
      text-align: left;
      animation: popIn .2s ease;
    }
    .modal h2 { margin:0 0 6px; color:var(--accent2); font-size:20px; }
    .modal p { margin:0 0 18px; color:#444; line-height:1.4; }
    .modal .controls { display:flex; justify-content:flex-end; gap:10px; margin-top:6px; }
    .btn-ghost { background:#eee; border:none; padding:10px 14px; border-radius:8px; cursor:pointer;}
    .btn-danger { background: linear-gradient(to right,var(--accent1),var(--accent2)); color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }

    /* ===== MAIN CONTENT ===== */
    .main {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
      transition: margin-left 0.4s;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to right, var(--accent1), var(--accent2));
      color: #fff;
      padding: 18px 30px;
      border-radius: 14px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .class-info { display:flex; flex-direction:column; }

    .class-title { font-size: 24px; font-weight:700; }
    .class-subject { font-size:15px; opacity:.9; }

    .month-nav { display:flex; align-items:center; justify-content:center; gap:15px; margin-bottom:20px; flex-wrap:wrap; }

    .calendar { display:grid; grid-template-columns: repeat(7, 1fr); gap: 10px; width:100%; margin:0 auto; }

    .day-name { text-align:center; font-weight:600; color:var(--accent2); font-size:14px; }

    .day-box {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 8px;
      min-height: 90px;
      position: relative;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      cursor: pointer;
    } 
     
    .student-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(5px);
  display: flex;
  justify-content: center;
  align-items: center;
  visibility: hidden;
  opacity: 0;
  transition: 0.3s ease;
  z-index: 9999;
}

.student-modal.active {
  visibility: visible;
  opacity: 1;
}

.student-modal-content {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 25px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  text-align: center;
}

.student-modal-content h3 {
  margin-bottom: 15px;
  color: var(--accent2);
}

#studentList {
  list-style: none;
  padding: 0;
  max-height: 200px;
  overflow-y: auto;
}

#studentList li {
  background: var(--sidebar-bg);
  margin: 5px 0;
  padding: 8px;
  border-radius: 8px;
}


    .day-number { position:absolute; top:8px; left:10px; font-size:13px; font-weight:700; color:var(--accent2); }
    .task-dot { width:10px; height:10px; border-radius:50%; position:absolute; bottom:8px; right:8px; background: linear-gradient(to bottom right, var(--accent1), var(--accent2)); }

    /* ===== TASK PANEL ===== */
    .task-panel { position: fixed; top:0; right:0; height:100vh; width:0; background:var(--card-bg); box-shadow:-4px 0 10px rgba(0,0,0,0.25); overflow-y:auto; padding:0; transition: width .36s; display:flex; flex-direction:column; z-index:1000; }
    .task-panel.open { width:420px; padding:25px; }

    input, textarea { width:100%; padding:10px; border-radius:8px; border:2px solid var(--input-border); margin-top:8px; margin-bottom:15px; }

    .task-buttons { display:flex; justify-content:space-between; margin-top:auto; }
    .save-btn { background:var(--accent1); color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; }
    .cancel-btn { background:#ccc; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; }

    /* small helpers */
    @keyframes popIn { from { transform: translateY(-6px) scale(.98); opacity:0 } to { transform: translateY(0) scale(1); opacity:1 } }
    @keyframes fadeIn { from { opacity:0 } to { opacity:1 } }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      body { flex-direction: column; height:auto; overflow-y:auto; }
      .sidebar {
        position: fixed; bottom:0; left:0; width:100%; height:65px; flex-direction:row;
        justify-content:space-around; padding:0; box-shadow:0 -2px 8px rgba(0,0,0,0.1); z-index:999;
      }
      .sidebar img { display:none; }
      .main { padding:20px; margin-bottom:70px; }
      .header { padding:15px; text-align:center; }
      .calendar { grid-template-columns: repeat(4, 1fr); }
      .task-panel.open { width:100%; padding:20px; }
    }

    @media (max-width: 768px) {
  .modal-content {
    width: 92%;
    max-width: 360px;
    margin: 20px auto;
    padding: 15px 18px;
    font-size: 15px;
  }

  .modal-content input,
  .modal-content textarea {
    font-size: 14px;
    padding: 10px;
  }

  .modal-content h2, 
  .modal-content h3 {
    font-size: 18px;
    margin-bottom: 10px;
  }

  .modal-content button {
    font-size: 14px;
    padding: 8px 14px;
  }
    }
    .has-task {
  background: linear-gradient(135deg, var(--accent1), var(--accent2));
  color: white;
  font-weight: 600;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: 0.3s ease;
}

.has-task:hover {
  transform: scale(1.03);
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
}


  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <img src="67eb2372-bf44-433b-bd1e-320f92ae8387.jpg" alt="Logo">
    <a href="index.html"><i class="fas fa-home"></i><br>Home</a>
    <a href="calendar.html"><i class="fas fa-calendar-alt"></i><br>Calendar</a>
    <a href="settings.html"><i class="fas fa-cog"></i><br>Settings</a>
  </div>

  <div class="main" id="main">
    <div class="header">
      <div class="class-info">
        <div class="class-title" id="classTitle">Class Name</div>
        <div class="class-subject" id="classSubject">Subject — Section</div>
        <div style="font-size:13px;opacity:.9" id="classCodeLabel"></div>
      </div>

      <div class="menu">
        <!-- professional menu button -->
        <div class="menu-wrap" aria-haspopup="true" aria-expanded="false">
          <button id="menuBtn" class="menuBtn" aria-label="Class menu">
            <span class="dots">
              <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            </span>
          </button>


          <div id="dropdownMenu" role="menu" aria-hidden="true">
            <a href="#" id="leaveClass" role="menuitem">Leave</a>
            <a href="#" id="deleteClass" role="menuitem" style="display:none">Delete (Creator)</a>
            <a class="menu-option" id="viewStudents">View Students</a>

          </div>
        </div>
      </div>
    </div>

    <div class="month-nav">
      <button id="prev" style="padding:10px 14px;border-radius:8px;border:none;background:linear-gradient(to right,var(--accent1),var(--accent2));color:#fff;cursor:pointer">◀ Prev</button>
      <div id="month-year" style="font-weight:700;color:var(--accent2)"></div>
      <button id="next" style="padding:10px 14px;border-radius:8px;border:none;background:linear-gradient(to right,var(--accent1),var(--accent2));color:#fff;cursor:pointer">Next ▶</button>
    </div>

    <div id="calendar-grid" class="calendar" aria-live="polite"></div>
  </div>

  <!-- task panel (right slide) -->
  <div id="taskPanel" class="task-panel" aria-hidden="true">
    <button id="closeTask" style="position:absolute;top:10px;right:15px;border:none;background:none;font-size:22px;cursor:pointer">×</button>
    <h3 id="selectedDate">Date</h3>
    <label>Title</label>
    <input id="taskTitle" placeholder="Enter task title...">
    <label>Description</label>
    <textarea id="taskDescription" placeholder="Enter details..."></textarea>
    <div class="task-buttons" style="margin-top:16px">
      <button id="saveTask" class="save-btn">Save</button>
      <button id="cancelTask" class="cancel-btn">Cancel</button>
    </div>
    <div id="taskMeta" style="margin-top:12px;font-size:13px;color:#666"></div>
  </div>

  <!-- overlay + modal for leave & delete -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div id="modalBox" class="modal" role="dialog" aria-modal="true">
      <h2 id="modalTitle">Confirm</h2>
      <p id="modalText">Are you sure?</p>
      <div class="controls">
        <button id="modalCancel" class="btn-ghost">Cancel</button>
        <button id="modalConfirm" class="btn-danger">Confirm</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, collection, getDocs, query, where,
      onSnapshot, addDoc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM
    const calendarGrid = document.getElementById("calendar-grid");
    const monthYear = document.getElementById("month-year");
    const classTitleEl = document.getElementById("classTitle");
    const classSubjectEl = document.getElementById("classSubject");
    const classCodeLabel = document.getElementById("classCodeLabel");

    const menuBtn = document.getElementById("menuBtn");
    const dropdownMenu = document.getElementById("dropdownMenu");
    const leaveClassBtn = document.getElementById("leaveClass");
    const deleteClassBtn = document.getElementById("deleteClass");

    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalText = document.getElementById("modalText");
    const modalCancel = document.getElementById("modalCancel");
    const modalConfirm = document.getElementById("modalConfirm");

    const taskPanel = document.getElementById("taskPanel");
    const closeTask = document.getElementById("closeTask");
    const saveTaskBtn = document.getElementById("saveTask");
    const cancelTaskBtn = document.getElementById("cancelTask");
    const taskTitle = document.getElementById("taskTitle");
    const taskDescription = document.getElementById("taskDescription");
    const selectedDateEl = document.getElementById("selectedDate");
    const taskMeta = document.getElementById("taskMeta");

    // state
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    let today = new Date();
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();
    let tasks = {};
    let currentUser = null;
    let classDoc = null;
    let classCode = null;
    let selectedDateKey = null;
    let unsubscribeTasks = null;

    // read classCode from URL
    const params = new URLSearchParams(window.location.search);
    classCode = params.get("code");
    if (!classCode) {
      alert("No class code provided. Returning to home.");
      window.location.href = "index.html";
    }

    const ymd = (y,m,d) => `${y}-${m+1}-${d}`;

    function generateCalendar(month, year) {
      calendarGrid.innerHTML = "";
      ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(dn => {
        const el = document.createElement("div"); el.className = "day-name"; el.textContent = dn; calendarGrid.appendChild(el);
      });

      const firstDay = new Date(year, month).getDay();
      const daysInMonth = 32 - new Date(year, month, 32).getDate();
      monthYear.textContent = `${monthNames[month]} ${year}`;

      for (let i=0;i<firstDay;i++) calendarGrid.appendChild(document.createElement("div"));

      for (let date=1; date<=daysInMonth; date++){
        const key = ymd(year,month,date);
        const box = document.createElement("div"); box.className="day-box"; box.setAttribute("data-date", key);
        const num = document.createElement("div"); num.className="day-number"; num.textContent = date; box.appendChild(num);

        if (tasks[key]) {
  box.classList.add("has-task");
}


        box.addEventListener("click", () => {
          const data = tasks[key] || null;
          openTaskPanel(key, `${monthNames[month]} ${date}, ${year}`, data);
        });

        calendarGrid.appendChild(box);
      }
    }

    // dropdown toggle
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isShown = dropdownMenu.classList.toggle("show");
      menuBtn.setAttribute("aria-expanded", isShown ? "true" : "false");
      dropdownMenu.setAttribute("aria-hidden", isShown ? "false" : "true");
    });

    // close when click outside
    document.addEventListener("click", (e) => {
      if (!dropdownMenu.contains(e.target) && !menuBtn.contains(e.target)) {
        dropdownMenu.classList.remove("show");
        menuBtn.setAttribute("aria-expanded", "false");
        dropdownMenu.setAttribute("aria-hidden", "true");
      }
    });

    // open/close task panel
    function openTaskPanel(key, displayDate, data = null) {
      selectedDateKey = key;
      taskPanel.classList.add("open");
      taskPanel.setAttribute("aria-hidden", "false");
      selectedDateEl.textContent = displayDate;
      if (data) {
        taskTitle.value = data.title || "";
        taskDescription.value = data.description || "";
        taskMeta.textContent = `Posted by: ${data.createdByEmail || data.createdBy || "—"} • ${data.createdAt ? (new Date(data.createdAt.seconds ? data.createdAt.seconds*1000 : data.createdAt)).toLocaleString() : ""}`;
        saveTaskBtn.dataset.taskId = data.id;
      } else {
        taskTitle.value = "";
        taskDescription.value = "";
        taskMeta.textContent = "";
        delete saveTaskBtn.dataset.taskId;
      }

      const canEdit = currentUser && classDoc && (classDoc.createdBy === currentUser.uid);
      if (canEdit) {
        taskTitle.disabled = false; taskDescription.disabled = false; saveTaskBtn.style.display = "inline-block";
      } else {
        taskTitle.disabled = true; taskDescription.disabled = true; saveTaskBtn.style.display = "none";
      }
    }
    function closeTaskPanel() {
      taskPanel.classList.remove("open");
      taskPanel.setAttribute("aria-hidden","true");
      selectedDateKey = null;
      delete saveTaskBtn.dataset.taskId;
    }

    closeTask.addEventListener("click", closeTaskPanel);
    cancelTaskBtn.addEventListener("click", closeTaskPanel);

    // firestore & auth
    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "login.html"; return; }
      currentUser = user;

      try {
        const classRef = doc(db, "classes", classCode);
        const classSnap = await getDoc(classRef);
        if (!classSnap.exists()) {
          alert("Class not found. It may have been deleted.");
          window.location.href = "index.html";
          return;
        }
        classDoc = classSnap.data();
        classTitleEl.textContent = classDoc.name || "Class";
        classSubjectEl.textContent = `${classDoc.subject || ""} — ${classDoc.section || ""}`;
        classCodeLabel.textContent = `Code: ${classDoc.code || classCode}`;

        // only show delete for creator
        if (classDoc.createdBy === currentUser.uid) {
          deleteClassBtn.style.display = "block";
        } else {
          deleteClassBtn.style.display = "none";
        }

        if (unsubscribeTasks) unsubscribeTasks();
        unsubscribeTasks = onSnapshot(collection(db, "classes", classCode, "tasks"), (snap) => {
          tasks = {};
          snap.forEach(s => {
            const d = s.data();
            tasks[d.date] = { id: s.id, ...d };
          });
          generateCalendar(currentMonth, currentYear);
        });

      } catch (err) {
        console.error("Load class error:", err);
        alert("Failed to load class.");
      }
    });

    // Save task (creator only)
    saveTaskBtn.addEventListener("click", async () => {
      if (!currentUser || !classDoc) return;
      const title = taskTitle.value.trim();
      const desc = taskDescription.value.trim();
      if (!title) return alert("Enter a title.");
      saveTaskBtn.disabled = true;
      try {
        const taskId = saveTaskBtn.dataset.taskId;
        const tasksCol = collection(db, "classes", classCode, "tasks");
        const payload = { date: selectedDateKey, title, description: desc, updatedAt: new Date() };

        if (taskId) {
          await updateDoc(doc(db, "classes", classCode, "tasks", taskId), payload);
        } else {
          payload.createdAt = new Date();
          payload.createdBy = currentUser.uid;
          payload.createdByEmail = currentUser.email || "";
          await addDoc(tasksCol, payload);
        }
        closeTaskPanel();
      } catch (err) {
        console.error("Save task error:", err);
        alert("Failed to save task.");
      }
      saveTaskBtn.disabled = false;
    });

    // Prev/Next month
    document.getElementById("prev").addEventListener("click", () => { currentMonth--; if (currentMonth<0){ currentMonth=11; currentYear--; } generateCalendar(currentMonth,currentYear); });
    document.getElementById("next").addEventListener("click", () => { currentMonth++; if (currentMonth>11){ currentMonth=0; currentYear++; } generateCalendar(currentMonth,currentYear); });

    // ---- Leave / Delete flows using the single modal overlay ----
    function showModal({title, text, confirmText="Confirm", onConfirm}) {
      modalTitle.textContent = title;
      modalText.textContent = text;
      modalConfirm.textContent = confirmText;
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden", "false");

      function cleanup() {
        overlay.classList.remove("show");
        overlay.setAttribute("aria-hidden", "true");
        modalCancel.removeEventListener("click", onCancel);
        modalConfirm.removeEventListener("click", onOk);
        document.removeEventListener("keydown", onEsc);
      }
      function onCancel(e){ e?.preventDefault?.(); cleanup(); }
      async function onOk(e){ e?.preventDefault?.(); cleanup(); await onConfirm(); }
      function onEsc(e){ if (e.key === "Escape") onCancel(); }

      modalCancel.addEventListener("click", onCancel);
      modalConfirm.addEventListener("click", onOk);
      document.addEventListener("keydown", onEsc);
    }

    // Leave class (remove joinedClasses and own classes entries)
    leaveClassBtn.addEventListener("click", (e) => {
      e.preventDefault();
      dropdownMenu.classList.remove("show");
      showModal({
        title: "Leave this class?",
        text: "If you leave this class you will lose access to its tasks and schedule. This action can be undone by joining again.",
        confirmText: "Leave Class",
        onConfirm: async () => {
          try {
            // remove from users/{uid}/joinedClasses (any docs with code)
            const joinedCol = collection(db, "users", currentUser.uid, "joinedClasses");
            const q = query(joinedCol, where("code", "==", classCode));
            const snaps = await getDocs(q);
            for (const s of snaps.docs) {
              await deleteDoc(doc(db, "users", currentUser.uid, "joinedClasses", s.id));
            }

            // also remove from users/{uid}/classes if teacher saved it
            const ownCol = collection(db, "users", currentUser.uid, "classes");
            const q2 = query(ownCol, where("code", "==", classCode));
            const snaps2 = await getDocs(q2);
            for (const s of snaps2.docs) {
              await deleteDoc(doc(db, "users", currentUser.uid, "classes", s.id));
            }

            // show inline confirmation then redirect
            const msg = document.createElement("div");
            msg.textContent = "You have left the class.";
            Object.assign(msg.style, {
              position: "fixed", top: "18px", left:"50%", transform:"translateX(-50%)",
              background:"linear-gradient(to right, var(--accent1), var(--accent2))", color:"#fff",
              padding:"10px 16px", borderRadius:"10px", zIndex:9999, fontWeight:700, boxShadow:"0 6px 20px rgba(0,0,0,.25)"
            });
            document.body.appendChild(msg);
            setTimeout(()=> { msg.style.transition="opacity .5s"; msg.style.opacity="0"; setTimeout(()=>{ msg.remove(); window.location.href="index.html"; },500); },1400);

          } catch (err) {
            console.error("Leave error:", err);
            alert("Failed to leave. Try again.");
          }
        }
      });
    });

    // Delete (creator) -- permanent removal of class doc and its tasks
    deleteClassBtn.addEventListener("click", (e) => {
      e.preventDefault();
      dropdownMenu.classList.remove("show");
      showModal({
        title: "Delete class?",
        text: "This will permanently delete the class and all its tasks for everyone. This cannot be undone.",
        confirmText: "Delete Class",
        onConfirm: async () => {
          try {
            // delete class tasks then class doc
            const tasksColRef = collection(db, "classes", classCode, "tasks");
            const snaps = await getDocs(tasksColRef);
            for (const s of snaps.docs) {
              await deleteDoc(doc(db, "classes", classCode, "tasks", s.id));
            }
            // delete class doc
            await deleteDoc(doc(db, "classes", classCode));

            // remove any references in users collections (best-effort)
            // NOTE: this may be slow; if you have many users consider backend function.
            // Attempt to remove from creator's own users/{uid}/classes as well:
            try {
              const ownCol = collection(db, "users", currentUser.uid, "classes");
              const q2 = query(ownCol, where("code","==", classCode));
              const snaps2 = await getDocs(q2);
              for (const s of snaps2.docs) {
                await deleteDoc(doc(db, "users", currentUser.uid, "classes", s.id));
              }
            } catch(e){ /* ignore */ }

            const msg = document.createElement("div");
            msg.textContent = "Class deleted.";
            Object.assign(msg.style, {
              position: "fixed", top: "18px", left:"50%", transform:"translateX(-50%)",
              background:"#222", color:"#fff",
              padding:"10px 16px", borderRadius:"10px", zIndex:9999, fontWeight:700
            });
            document.body.appendChild(msg);
            setTimeout(()=> { msg.style.transition="opacity .5s"; msg.style.opacity="0"; setTimeout(()=>{ msg.remove(); window.location.href="index.html"; },500); },1200);

          } catch (err) {
            console.error("Delete error:", err);
            alert("Failed to delete class. Try again.");
          }
        }
      });
    }); 
    
   // ===== View Students Modal =====  
const viewStudentsBtn = document.getElementById("viewStudents");
const studentModal = document.createElement("div");
studentModal.classList.add("student-modal");
studentModal.innerHTML = `
  <div class="student-modal-content">
    <h3>Student List</h3>
    <ul id="studentList"></ul>
    <button id="closeStudentModal">Close</button>
  </div>
`;
document.body.appendChild(studentModal);

viewStudentsBtn?.addEventListener("click", async () => {
  studentModal.classList.add("active");
  dropdownMenu.classList.remove("show");
  const studentList = document.getElementById("studentList");
  studentList.innerHTML = "<li>Loading...</li>";

  try {
    // get students subcollection
    const studentsRef = collection(db, "classes", classCode, "students");
    const snap = await getDocs(studentsRef);

    if (snap.empty) {
      studentList.innerHTML = "<li>No students yet.</li>";
      return;
    }

    const items = [];
    snap.forEach(doc => {
      const d = doc.data();
      items.push(`<li>${d.name || d.email || doc.id}</li>`);
    });

    studentList.innerHTML = items.join("");
  } catch (e) {
    console.error("Error fetching students:", e);
    studentList.innerHTML = "<li>Failed to load students.</li>";
  }
});

document.getElementById("closeStudentModal").addEventListener("click", () => {
  studentModal.classList.remove("active");
});
studentModal.addEventListener("click", (e) => {
  if (e.target === studentModal) studentModal.classList.remove("active");
});


    // initial calendar render
    generateCalendar(currentMonth, currentYear);

  </script>
</body>
</html>
